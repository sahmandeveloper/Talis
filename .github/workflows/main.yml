name: SSH to Ubuntu with Ngrok
on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Install ngrok
        run: |
          sudo apt-get update
          sudo apt-get install -y wget
          wget https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip
          unzip ngrok-stable-linux-amd64.zip
          sudo mv ngrok /usr/local/bin/
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}

      - name: Start SSH and Ngrok
        run: |
          sudo apt-get install -y openssh-server
          sudo sed -i 's/#PasswordAuthentication/PasswordAuthentication/g' /etc/ssh/sshd_config
          sudo service ssh restart
          nohup ssh -o "StrictHostKeyChecking=no" -R 22:localhost:22 ${{ secrets.NGROK_AUTH_TOKEN }}@ssh.ngrok.io > /dev/null 2>&1 &
